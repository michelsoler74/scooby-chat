<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scooby - Tu Amigo Virtual</title>
    <!-- Forzar recarga del CSS con un par√°metro de versi√≥n -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link href="src/css/styles.css?v=1.1" rel="stylesheet" />
    <!-- Estilo inline para asegurar que el cuadro de consejos est√° oculto -->
    <style>
      .mic-help-info {
        display: none !important;
      }

      .help-toggle {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #17a2b8;
        color: white;
        border: none;
        cursor: pointer;
        z-index: 10;
      }

      .mic-help-tooltip {
        position: absolute;
        top: 100%;
        right: 10px;
        width: 300px;
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 12px 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transform: translateY(10px);
        transition: all 0.3s ease;
        text-align: left;
      }

      .mic-help-tooltip.show,
      .mic-help-tooltip.show-persistent {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <!-- Header -->
      <header>
        <div class="header-content">
          <h1 class="text-center">Scooby - Tu Amigo Virtual</h1>
          <button
            id="help-toggle"
            class="btn btn-sm btn-info help-toggle"
            title="Consejos de uso"
          >
            <span>‚ùì</span>
          </button>

          <!-- Tooltip de ayuda (inicialmente oculto) -->
          <div id="mic-help-tooltip" class="mic-help-tooltip">
            <h5 class="alert-heading">Consejos para usar el micr√≥fono:</h5>
            <ul class="mb-0">
              <li>Habla fuerte y claro, cerca del micr√≥fono</li>
              <li>
                Aseg√∫rate que el volumen del micr√≥fono est√© al m√°ximo en Windows
              </li>
              <li>
                Si hay errores "no-speech", utiliza el modo de texto escribiendo
                en el campo de entrada
              </li>
              <li>
                Verifica que has dado permisos al navegador para usar el
                micr√≥fono
              </li>
            </ul>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <main>
        <!-- Chat Section -->
        <div class="chat-section">
          <!-- Conversation Area -->
          <div id="conversation">
            <!-- Messages will be added here -->
          </div>

          <!-- Input Area -->
          <div class="input-area">
            <div class="input-group">
              <input
                type="text"
                id="text-input"
                class="form-control"
                placeholder="Escribe tu mensaje aqu√≠..."
              />
              <button id="send-btn" class="btn btn-primary">Enviar</button>
            </div>

            <!-- Voice Controls -->
            <div class="buttons-container">
              <button id="talk-btn" class="btn btn-success">
                Hablar con Scooby
              </button>
              <button id="stop-btn" class="btn btn-secondary" disabled>
                Detener
              </button>
              <button id="resume-btn" class="btn btn-warning" disabled>
                Continuar
              </button>
              <button id="continue-btn" class="btn btn-warning d-none">
                <span>üîÑ ¬°Quiero saber m√°s!</span>
              </button>
              <button id="clear-chat-btn" class="btn btn-info">
                <span>üßπ Limpiar chat</span>
              </button>
            </div>

            <!-- Microphone Status -->
            <div id="mic-status">
              <small class="text-muted"
                >Estado del micr√≥fono: Verificando...</small
              >
            </div>
          </div>
        </div>

        <!-- Scooby Video Section -->
        <div class="video-section">
          <div class="video-container">
            <video id="scooby-callado" loop muted>
              <source
                src="src/assets/videos/scooby-callado.mp4"
                type="video/mp4"
              />
            </video>
            <video id="scooby-hablando" class="d-none" loop>
              <source src="src/assets/videos/scooby.mp4" type="video/mp4" />
            </video>
          </div>
        </div>
      </main>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module" src="src/js/app.js?v=1.1"></script>

    <!-- Script para verificar el estado del micr√≥fono y gestionar tooltip -->
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const micStatus = document.getElementById("mic-status");

        // Configurar el tooltip de ayuda
        const helpToggle = document.getElementById("help-toggle");
        const micHelpTooltip = document.getElementById("mic-help-tooltip");

        if (helpToggle && micHelpTooltip) {
          console.log("Configurando eventos del tooltip");

          // Detectar si es dispositivo m√≥vil
          const isMobile = window.innerWidth <= 768 || "ontouchstart" in window;

          if (isMobile) {
            // En m√≥vil solo mostrar/ocultar con clic
            helpToggle.addEventListener("click", function (event) {
              event.preventDefault();
              event.stopPropagation();
              console.log("Clic en bot√≥n de ayuda (m√≥vil)");
              micHelpTooltip.classList.toggle("show-persistent");
            });

            // A√±adir evento para cerrar tooltip al hacer clic en la X
            micHelpTooltip.addEventListener("click", function (event) {
              if (
                event.target === micHelpTooltip ||
                (event.clientX >
                  micHelpTooltip.getBoundingClientRect().right - 30 &&
                  event.clientY <
                    micHelpTooltip.getBoundingClientRect().top + 30)
              ) {
                console.log("Cerrando tooltip (m√≥vil)");
                micHelpTooltip.classList.remove("show-persistent");
                micHelpTooltip.classList.remove("show");
              }
            });

            // Cerrar al hacer clic en cualquier parte del documento
            document.addEventListener("click", function (event) {
              if (
                !micHelpTooltip.contains(event.target) &&
                event.target !== helpToggle
              ) {
                micHelpTooltip.classList.remove("show-persistent");
                micHelpTooltip.classList.remove("show");
              }
            });
          } else {
            // En desktop usar hover y clic
            helpToggle.addEventListener("mouseenter", () => {
              console.log("Mouse enter en bot√≥n de ayuda");
              micHelpTooltip.classList.add("show");
            });

            helpToggle.addEventListener("mouseleave", () => {
              console.log("Mouse leave en bot√≥n de ayuda");
              if (!micHelpTooltip.classList.contains("show-persistent")) {
                micHelpTooltip.classList.remove("show");
              }
            });

            helpToggle.addEventListener("click", () => {
              console.log("Clic en bot√≥n de ayuda");
              micHelpTooltip.classList.toggle("show-persistent");
            });
          }

          // Ocultamos cualquier posible panel de consejos antiguo
          const oldHelpPanel = document.querySelector(".mic-help-info");
          if (oldHelpPanel) {
            oldHelpPanel.style.display = "none";
            oldHelpPanel.classList.add("d-none");
          }
        }

        // Verificar soporte de SpeechRecognition
        const SpeechRecognition =
          window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
          micStatus.innerHTML =
            '<small class="text-danger">‚ùå Tu navegador no soporta reconocimiento de voz. Por favor usa Chrome o Edge.</small>';
          return;
        }

        try {
          console.log("Verificando permisos del micr√≥fono...");
          console.log("User Agent:", navigator.userAgent);

          // Enumerar dispositivos de audio
          const devices = await navigator.mediaDevices.enumerateDevices();
          const audioDevices = devices.filter(
            (device) => device.kind === "audioinput"
          );
          console.log("Dispositivos de audio disponibles:", audioDevices);

          if (audioDevices.length === 0) {
            micStatus.innerHTML =
              '<small class="text-danger">‚ùå No se detect√≥ ning√∫n micr√≥fono</small>';
            return;
          }

          // Solicitar permisos del micr√≥fono
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: {
              echoCancellation: true,
              noiseSuppression: true,
              autoGainControl: true,
            },
          });

          console.log(
            "Configuraci√≥n de audio:",
            stream.getAudioTracks()[0].getSettings()
          );
          micStatus.innerHTML =
            '<small class="text-success">‚úÖ Micr√≥fono detectado y funcionando</small>';

          // Detener el stream de prueba
          stream.getTracks().forEach((track) => track.stop());
        } catch (error) {
          console.error("Error al acceder al micr√≥fono:", error);
          let errorMessage = "‚ùå Error: ";

          if (error.name === "NotAllowedError") {
            errorMessage +=
              "Permiso denegado. Por favor, permite el acceso al micr√≥fono.";
          } else if (error.name === "NotFoundError") {
            errorMessage +=
              "No se encontr√≥ ning√∫n micr√≥fono. Verifica que est√© conectado.";
          } else {
            errorMessage += error.message;
          }

          micStatus.innerHTML = `<small class="text-danger">${errorMessage}</small>`;
        }

        // Ajustes espec√≠ficos para m√≥vil
        if (window.innerWidth <= 768) {
          // Asegurarnos de que el √°rea de conversaci√≥n es scrollable
          const conversation = document.getElementById("conversation");
          if (conversation) {
            conversation.style.overflowY = "auto";
            conversation.style.webkitOverflowScrolling = "touch";
          }

          // Ajustar la altura de la ventana en iOS para manejar barra de direcciones
          const setVh = () => {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty("--vh", `${vh}px`);
          };

          setVh();
          window.addEventListener("resize", setVh);
        }
      });
    </script>
  </body>
</html>
